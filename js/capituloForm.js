$(document).ready(function () {
    const $form = $("#capituloForm");
    const $tituloInput = $("#titulo");
    const $paginaFinalInput = $("#paginaFinal");
    const $capitulosTableBody = $("#capitulosTable tbody");
    const $ultimaPagina = $("#ultimaPagina");
    const $ultimaPagina1 = $("#ultimaPagina1");

    $form.on("submit", function (event) {
        event.preventDefault();

        const etiquetaSeleccionada = $("input[name='etiqueta']:checked").val();
        if (!etiquetaSeleccionada) {
            alert("Por favor, selecciona una etiqueta antes de agregar un cap칤tulo.");
            return;
        }

        const titulo = $tituloInput.val().trim();
        if (!titulo) {
            alert("El t칤tulo no puede estar vac칤o.");
            return;
        }

        const paginaFinal = parseInt($paginaFinalInput.val(), 10);
        if (isNaN(paginaFinal) || paginaFinal < window.siguientePagina) {
            alert("La p치gina final debe ser v치lida y no menor a la inicial.");
            return;
        }

        if (paginaFinal > 200) {
            alert("La p치gina final no puede ser mayor a 200.");
            return;
        }

        const tituloCompleto = `${etiquetaSeleccionada}: ${titulo}`;

        $.ajax({
            url: 'rene/agregar_capitulo.php',
            type: 'POST',
            data: {
                caja: window.caja,
                carpeta: window.carpeta,
                titulo: tituloCompleto,
                paginaFinal: paginaFinal,
                serie: etiquetaSeleccionada
            },
            dataType: 'json',

success: function (response) {
    if (response.status === 'success') {
        const nuevoCapitulo = response.capitulo;

        const filaMensaje = $capitulosTableBody.find("tr td[colspan='5']").closest("tr");
        if (filaMensaje.length) filaMensaje.remove();

        const nuevaFila = $(`
            <tr data-id="${nuevoCapitulo.id}" data-num-paginas="${nuevoCapitulo.num_paginas}">
                <td class="drag-column"><span class="drag-icon">&#x21D5;</span></td>
                <td contenteditable="true" class="editable">${nuevoCapitulo.titulo}</td>
                <td>${nuevoCapitulo.pagina_inicio}</td>
                <td>${nuevoCapitulo.pagina_final}</td>
                <td><button class="btn btn-dark btn-sm editar">Editar</button></td>
            </tr>
        `);
        $capitulosTableBody.append(nuevaFila);

        // 游댳 Actualizamos la pr칩xima p치gina
        window.siguientePagina = parseInt(nuevoCapitulo.pagina_final) + 1;
        $ultimaPagina.text(`칔ltimo folio: ${window.siguientePagina}`);

        // 游댳 Reseteamos el input y actualizamos su min din치mico
        $paginaFinalInput.val(window.siguientePagina);
        $paginaFinalInput.attr("min", window.siguientePagina);

        $tituloInput.val('').focus();
        window.textoFinal = ''; 

        document.dispatchEvent(new Event("capitulo-agregado"));
    } else {
        alert(response.message || "Error al agregar el cap칤tulo.");
    }
},

            error: function (xhr) {
                console.error("Error:", xhr.responseText);
                alert("Fallo la solicitud.");
            }
        });
    });
});
